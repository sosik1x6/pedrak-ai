<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <title>Pedrak-AI</title>
    <style>
        #chat {
            border: 1px solid #ccc;
            padding: 10px;
            height: 300px;
            overflow-y: scroll;
        }
        .message {
            margin: 5px 0;
        }
        
        .api-response strong {
            font-weight: bold;
        }

        .api-response em {
            font-style: italic;
        }

        .api-response pre {
            background: #2d2d2d;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            overflow-x: auto;
        }

        .api-response code {
            color: #fff;
            font-family: 'Courier New', Courier, monospace;
            background: #2d2d2d;
            padding: 2px 5px;
            border-radius: 3px;
        }

        .api-response blockquote {
            border-left: 4px solid #666;
            margin: 10px 0;
            padding-left: 15px;
            color: #fff;
        }
        
        [data-stopped] {
            color: #ff4444;
            font-style: italic;
        }

        [data-error] {
            color: #ff0000;
            background: rgba(255, 0, 0, 0.1);
            padding: 5px;
            border-radius: 3px;
        }      

        #pedrakphot {
            height: 300px;
            width: 300px;            
        }
    </style>
</head>
<body>
    <img src="pedrak2.png" alt="pedrak" id="pedrakphot">
    <h1>Pedrak-AI</h1>
    <button id="loadButton">Wczytaj</button>
    <button id="newSessionButton">Nowa Sesja</button>
    <div id="chat"></div>
    <input type="text" id="userInput" placeholder="Wpisz wiadomość..." />
    <button id="sendMessage">Wyślij</button>
    <h2 id="sessionCode">ID SESJI:</h2>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js"></script>
    <script>
        // Konfiguracja DOMPurify dla MathJax
        DOMPurify.addHook('afterSanitizeAttributes', function(node) {
            if (node.tagName === 'MATH') {
                node.setAttribute('xmlns', 'http://www.w3.org/1998/Math/MathML');
            }
            if (node.hasAttribute('display')) {
                node.setAttribute('display', 'block');
            }
        });
    </script>
    <script>
        MathJax = {
          tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$'], ['\\[', '\\]']]
          },
          options: {
            skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
          }
        };
      </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js"></script>
    <script>

        

        // Dodaj te zmienne globalne

        let isProcessing = false;

        const KV_BASE_URL = 'https://pedrak-worker.sosik111111.workers.dev';
        let currentSessionId;
        let chatHistory = [];

        let isInitialized = false;

        let currentController = null;
        let currentReader = null;
        let isStreaming = false;
        const chatDiv = document.getElementById('chat');
        const userInput = document.getElementById('userInput');
        const sendMessageButton = document.getElementById('sendMessage');

        const KV_BASE = 'https://pedrak-worker.sosik111111.workers.dev';

        marked.setOptions({
  breaks: true,
  gfm: true,
  mangle: false,    // Wyłącz zamianę podkreśleń
  headerIds: false  // Wyłącz automatyczne ID nagłówków
});

async function initializeApp() {
            currentSessionId = getSessionFromCookie() || generateSessionId();
            saveSessionToCookie(currentSessionId);
            document.getElementById('sessionCode').textContent = `ID SESJI: ${currentSessionId}`;
            await loadSessionData();
        }
        async function loadSessionData() {
            try {
                const response = await fetch(`${KV_BASE_URL}/load`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id: currentSessionId })
                });
                
                if(response.ok) {
                    const sessionData = await response.json();
                    chatDiv.innerHTML = '';
                    chatHistory = sessionData.history || [];
                    
                    chatHistory.forEach(msg => {
                        appendMessage(msg.content, msg.role === 'assistant');
                    });
                }
            } catch(error) {
                console.error('Błąd ładowania:', error);
            }
        }
    initializeApp();

        function saveSessionToCookie(sessionId) {
            const expires = new Date();
            expires.setFullYear(expires.getFullYear() + 1);
            document.cookie = `pedrak_session=${encodeURIComponent(sessionId)}; expires=${expires.toUTCString()}; path=/; SameSite=Lax`;
        } 
        function getSessionFromCookie() {
        const cookies = document.cookie.split(';');
        for(let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if(name === 'pedrak_session') {
            return decodeURIComponent(value);
        }
        }
        return null;
        }


    function generateSessionId() {
    return 'pedrak-' + crypto.randomUUID().slice(0, 8);
    }

    function initSession() {
    const savedSession = getSessionFromCookie();
    if(savedSession) {
        currentSessionId = savedSession;
    } else {
        currentSessionId = generateSessionId();
        saveSessionToCookie(currentSessionId);
    }

    const sessionElement = document.getElementById('sessionCode');
    sessionElement.textContent = `ID SESJI: ${currentSessionId}`;
    sessionElement.style.color = '#ff0000';
    sessionElement.style.cursor = 'pointer';
    
    sessionElement.addEventListener('click', () => {
        navigator.clipboard.writeText(currentSessionId);
    });
    }

    document.addEventListener('DOMContentLoaded', async () => {
    initSession(); 
    
    try {
        // Najpierw spróbuj załadować historię
        const response = await fetch(`${KV_BASE}/load?id=${currentSessionId}`);
        if(response.ok) {
            const history = JSON.parse(await response.text());
            chatDiv.innerHTML = '';
            
            history.forEach(msg => {
                if(msg.isBot) {
                    const div = document.createElement('div');
                    div.className = 'message api-response';
                    div.innerHTML = `
                        <span class="prefix">Pedrak-AI: </span>
                        <span class="content">${DOMPurify.sanitize(msg.content)}</span>
                    `;
                    chatDiv.appendChild(div);
                } else {
                    appendMessage(msg.content.startsWith('Ty: ') ? msg.content : `Ty: ${msg.content}`);
                }
            });
        }
        await updateSessionTTL();
    } catch(error) {
        console.error('Błąd ładowania sesji:', error);
    }
});

// Dodaj autozapis przed zamknięciem
window.addEventListener('beforeunload', async (e) => {
    if(chatDiv.children.length > 0) {
        e.preventDefault();
        await saveSession();
        e.returnValue = '';
    }
});

async function saveSession() {
            try {
                const response = await fetch(`${KV_BASE_URL}/save`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        id: currentSessionId,
                        data: {
                            history: chatHistory,
                            summary: '' // Dodaj summary jeśli potrzebne
                        }
                    })
                });
                
                if(!response.ok) throw new Error('Błąd zapisu');
                await updateSessionTTL();
            } catch (error) {
                alert(`Błąd zapisu: ${error.message}`);
            }
        }

async function loadSessionData() {
            try {
                const response = await fetch(`${KV_BASE_URL}/load`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id: currentSessionId })
                });
                
                if(response.ok) {
                    const sessionData = await response.json();
                    chatDiv.innerHTML = '';
                    chatHistory = sessionData.history || [];
                    
                    chatHistory.forEach(msg => {
                        appendMessage(msg.content, msg.role === 'assistant');
                    });
                }
            } catch(error) {
                console.error('Błąd ładowania:', error);
            }
        }

        async function loadSession() {
            const sessionCode = prompt('Podaj ID sesji:').trim();
            if (!sessionCode) return;

            currentSessionId = sessionCode;
            saveSessionToCookie(currentSessionId);
            document.getElementById('sessionCode').textContent = `ID SESJI: ${currentSessionId}`;
            await loadSessionData();
        }


    // Zapisywanie Sesji
    async function saveSession() {
    const history = Array.from(chatDiv.children).map(msg => {
        const isBot = msg.classList.contains('api-response');
        return {
            content: isBot ? 
                msg.querySelector('.content').innerHTML :
                msg.textContent.replace('Ty: ', '').trim(),
            isBot: isBot
        };
    });

    try {
        const response = await fetch(`${KV_BASE}/save`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                id: currentSessionId,
                data: history
            })
        });
        
        if(response.ok) {
            saveSessionToCookie(currentSessionId); // Aktualizuj cookie
        }
        
        if(!response.ok) throw new Error(await response.text());
        
        await updateSessionTTL();
    } catch (error) {
        alert(`[KURWA, NIE ZAPISAŁO SIĘ: ${error.message}]`);
    }
}


    // Aktualizacja czasu życia sesji
    async function updateSessionTTL() {
    try {
        // Dodaj abort controller z timeoutem
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        await fetch(`${KV_BASE_URL}/keepalive?id=${currentSessionId}`, {
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
    } catch (error) {
        console.error('Błąd aktualizacji TTL:', error);
    }
    }
    // Event listenery dla nowych przycisków
        document.getElementById('loadButton').addEventListener('click', loadSession);

        document.getElementById('sendMessage').addEventListener('click', () => {
    const message = userInput.value.trim();
    if(message) {
        userInput.value = '';
        sendMessageToAPI(message);
    }
});

        function appendMessage(content, isBot) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isBot ? 'api-response' : ''}`;
            
            if(isBot) {
                messageDiv.innerHTML = `
                    <span class="prefix">Pedrak-AI: </span>
                    <span class="content">${DOMPurify.sanitize(marked.parse(content))}</span>
                `;
            } else {
                messageDiv.innerHTML = `
                    <span class="prefix">Ty: </span>
                    <span>${content}</span>
                `;
            }
            
            chatDiv.appendChild(messageDiv);
            chatDiv.scrollTop = chatDiv.scrollHeight;
            MathJax.typesetPromise([messageDiv]).catch(console.error);
        }


    

        document.getElementById('newSessionButton').addEventListener('click', async () => {
    if(confirm('NA PEWNO CHCESZ NOWĄ SESJĘ? STARA ZOSTANIE WYJEBANA DO KOSZA!')) {
        currentSessionId = generateSessionId();
        saveSessionToCookie(currentSessionId);
        chatDiv.innerHTML = '';
        chatHistory = [];
        document.getElementById('sessionCode').textContent = `ID SESJI: ${currentSessionId}`;
    }
});

    
    chatDiv.appendChild(messageDiv);
    chatDiv.scrollTop = chatDiv.scrollHeight;
    async function sendMessageToAPI(message) {
            if (isProcessing) return;
            isProcessing = true;
            
            try {
                // Dodaj wiadomość użytkownika do historii
                appendMessage(message, false);
                chatHistory.push({
                    role: 'user',
                    content: message,
                    timestamp: Date.now(),
                    important: false
                });

                // Wywołaj endpoint /chat
                const response = await fetch(`${KV_BASE_URL}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-ID': currentSessionId
                    },
                    body: JSON.stringify({ message })
                });

                // Obsłuż odpowiedź
                const responseText = await response.text();
                appendMessage(responseText, true);
                chatHistory.push({
                    role: 'assistant',
                    content: responseText,
                    timestamp: Date.now(),
                    important: false
                });

                await saveSession();

            } catch (error) {
                alert(`Błąd: ${error.message}`);
            } finally {
                isProcessing = false;
            }
        }


    const url = `${baseUrl}?${params.toString()}`;
    
    // Inicjalizacja nowego kontrolera i czytnika
    currentController = new AbortController();
    let reader = null;
    isStreaming = true;
    
    try {
        const apiResponseDiv = document.createElement('div');
        apiResponseDiv.className = 'message api-response mathjax-loading';
        apiResponseDiv.innerHTML = '<span class="prefix">Pedrak-AI: </span><span class="content"></span>';
        chatDiv.appendChild(apiResponseDiv);

        const response = await fetch(url, { signal: currentController.signal });
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (isStreaming) {
            const { done, value } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });
            const parsed = DOMPurify.sanitize(marked.parse(buffer.replace(/\\(?!\\)/g, "\\\\")));
            
            apiResponseDiv.querySelector('.content').innerHTML = parsed;
            
            if (buffer.includes('$')) {
                await MathJax.typesetPromise([apiResponseDiv]);
            }
        }

        const finalContent = DOMPurify.sanitize(marked.parse(buffer.replace(/\\/g, "\\\\")));
        apiResponseDiv.querySelector('.content').innerHTML = finalContent;
        await MathJax.typesetPromise([apiResponseDiv]);

    } catch (error) {
        if (error.name === 'AbortError') {
            console.log('Przerwano na życzenie użytkownika');
            alert('[Zatrzymano przez użytkownika]');
        } else {
            console.error('Błąd:', error);
            alert('[KURWA, COŚ SIĘ POSRAPAŁO!]');
        }
    } finally {
        // Sprzątanie zasobów
        if (reader) {
            try {
                await reader.cancel();
            } catch (e) {
                console.log('Błąd anulowania strumienia:', e);
            }
        }
        
        isProcessing = false;
        isStreaming = false;
        currentController = null;
        
        // Zapisz sesję jeśli jest zawartość
        const contentElements = document.querySelectorAll('.content');
        if (contentElements.length > 0 && contentElements[contentElements.length - 1].innerHTML !== '') {
            await saveSession();
            await updateSessionTTL();
        }
    }

    </script>
</body>
</html>